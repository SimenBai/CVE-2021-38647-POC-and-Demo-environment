#Download base image ubuntu 20.04
FROM ubuntu:20.04

# LABEL about the custom image
LABEL maintainer="docker@simenbai.no"
LABEL version="1"
LABEL description="Docker container for testing the OMI god exploit (CVE-2021-38647)"

# Disable Prompt During Packages Installation
#ARG DEBIAN_FRONTEND=noninteractive

# Update Ubuntu Software repository and install necesarry dependencies

RUN apt-get update && apt-get install -qq -y openssl wget nano vim python3 && \
    rm -rf /var/lib/apt/lists/* && \
    apt clean

# Installing vulnerable omi version
RUN wget https://github.com/microsoft/omi/releases/download/v1.6.8-0/omi-1.6.8-0.ssl_110.ulinux.x64.deb
RUN dpkg -i ./omi-1.6.8-0.ssl_110.ulinux.x64.deb

# Opening listening port for binary protocol
RUN sed -i 's/httpsport=0/httpsport=5986/g' /etc/opt/omi/conf/omiserver.conf    

# Installing SCX so we don't get namespace error
RUN wget https://github.com/microsoft/SCXcore/releases/download/v1.6.8-1/scx-1.6.8-1.ssl_110.ulinux.x64.deb
RUN dpkg -i ./scx-1.6.8-1.ssl_110.ulinux.x64.deb

RUN service omid restart
